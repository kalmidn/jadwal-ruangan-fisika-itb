const START_HOUR=7,END_HOUR=17,SHOW_PENDING_PUBLIC=!1,SINGLE_BUILDING_MODE=!0,ACTIVE_BUILDING="Gedung Fisika",ACTIVE_ROOM_IDS=[],DEMO={rooms:[{id:"R101",name:"Room 101",location:"Level 1",capacity:30,building:"Gedung Fisika"},{id:"R102",name:"Room 102",location:"Level 1",capacity:24,building:"Gedung Fisika"},{id:"LabA",name:"Lab A",location:"Level 2",capacity:20,building:"Gedung Fisika"},{id:"LXV-301",name:"Labtek XV 301",location:"Level 3",capacity:30,building:"Labtek XV"}],bookings:[{room_id:"R101",date:"2025-09-05",start:"07:00",end:"10:00",title:"Physics 101",pic_name:"Dr. Sari",status:"fixed",source:"fixed"},{room_id:"R101",date:"2025-09-05",start:"13:00",end:"15:00",title:"Dept Meeting",pic_name:"Prof. Adi",status:"approved",source:"request"},{room_id:"R102",date:"2025-09-05",start:"09:00",end:"12:00",title:"Seminar",pic_name:"Guest",status:"approved",source:"request"},{room_id:"LabA",date:"2025-09-05",start:"08:00",end:"11:00",title:"Lab Practicum",pic_name:"Irna",status:"fixed",source:"fixed"},{room_id:"LabA",date:"2025-09-05",start:"14:00",end:"16:00",title:"Experiment",pic_name:"Yusuf",status:"pending",source:"request"},{room_id:"R101",date_from:"2025-11-01",date_to:"2025-11-07",start:"00:00",end:"23:59",title:"Maintenance",status:"fixed"},{room_id:"R102",date_from:"2025-09-15",date_to:"2025-12-20",start:"08:00",end:"10:00",title:"Kuliah Wajib",status:"fixed",byweekday:["MO","TU","WE","TH","FR"]}]},pad2=e=>String(e).padStart(2,"0"),fmtDate=e=>`${e.getFullYear()}-${pad2(e.getMonth()+1)}-${pad2(e.getDate())}`,parseTime=e=>{const[t,a]=e.split(":").map(Number);return t+a/60},byId=e=>document.getElementById(e),escapeHTML=e=>String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#39;");function setDateInput(e){byId("datePicker").value=e}function hoursArray(){const e=[];for(let t=START_HOUR;t<END_HOUR;t++)e.push(t);return e}function nearestBookedDate(e,t){if(!Array.isArray(e)||0===e.length)return t;const a=new Date(t),n=Array.from(new Set(e.map((e=>e.date))));return n.sort(((e,t)=>Math.abs(new Date(e)-a)-Math.abs(new Date(t)-a))),n[0]||t}const WEEKDAY_MAP={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};function parseYMD(e){const[t,a,n]=e.split("-").map(Number);return new Date(t,a-1,n)}function addDays(e,t){const a=new Date(e);return a.setDate(a.getDate()+t),a}function expandFixedBookings(e){const t={rooms:e.rooms||[],bookings:[]};for(const a of e.bookings||[]){const e=a.date_from&&a.date_to,n=(a.byweekday||[]).map((e=>WEEKDAY_MAP[String(e).toUpperCase()])).filter((e=>Number.isInteger(e))),i=n.length>0;if("fixed"!==a.status||!e&&!i&&a.date){t.bookings.push(a);continue}const o=parseYMD(a.date_from||a.date),d=parseYMD(a.date_to||a.date_from||a.date);for(let e=new Date(o);e<=d;e=addDays(e,1))i&&!n.includes(e.getDay())||t.bookings.push({...a,date:`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}-${String(e.getDate()).padStart(2,"0")}`,date_from:void 0,date_to:void 0})}return t}function buildDayGrid({rooms:e,bookings:t},a,n,i,o){const d=byId("grid");d.innerHTML="";let r=e||[];n&&"all"!==n&&(r=r.filter((e=>(e.building||"")===n))),r=i&&"all"!==i?r.filter((e=>e.id===i)):r,r=r.filter((e=>"Gedung Fisika"===(e.building||"")||ACTIVE_ROOM_IDS.length&&ACTIVE_ROOM_IDS.includes(e.id))),d.style.gridTemplateColumns=`100px repeat(${r.length}, minmax(180px, 1fr))`;const s=hoursArray(),l=document.createElement("div");l.className="time-col header grid-header",l.textContent=new Date(a).toLocaleDateString(void 0,{weekday:"short",year:"numeric",month:"short",day:"numeric"}),d.appendChild(l),r.forEach((e=>{const t=document.createElement("div");t.className="room-header grid-header",t.textContent=e.name,d.appendChild(t)}));const c=t.filter((e=>e.date===a)).filter((e=>"all"===o||e.status===o)).filter((e=>"pending"!==e.status)),u=new Map;r.forEach((e=>u.set(e.id,[]))),c.forEach((e=>{u.has(e.room_id)&&u.get(e.room_id).push(e)}));for(const e of u.values())e.sort(((e,t)=>parseTime(e.start)-parseTime(t.start)));s.forEach((e=>{const t=document.createElement("div");t.className="time-col",t.textContent=`${pad2(e)}:00`,d.appendChild(t),r.forEach((()=>{const e=document.createElement("div");e.className="cell",d.appendChild(e)}))}));const m=r.length;r.forEach(((e,t)=>{(u.get(e.id)||[]).forEach((e=>{const a=Math.max(parseTime(e.start),START_HOUR),n=Math.min(parseTime(e.end),END_HOUR);if(n<=START_HOUR||a>=END_HOUR)return;const i=Math.floor(a-START_HOUR)+1,o=1*(m+1)+(i-1)*(m+1)+1+t+1,r=d.children[o-1];if(!r)return;const s=document.createElement("div");s.className=`block ${"fixed"===e.status?"fixed":e.status}`,s.style.top=4+56*(a-Math.floor(a))+"px",s.style.height=`${Math.max(56*(n-a)-8,40)}px`,s.innerHTML=`\n        <div class="title">${escapeHTML(e.title||"Booked")}</div>\n        <div class="meta">${e.pic_name?escapeHTML(e.pic_name):""} · ${e.start}–${e.end}</div>\n      `,r.appendChild(s)}))}))}function daysInMonth(e,t){return new Date(e,t+1,0).getDate()}function isWeekend(e,t,a){const n=new Date(e,t,a).getDay();return 0===n||6===n}function buildMonthGrid({rooms:e,bookings:t},a,n,i,o){const d=a.getFullYear(),r=a.getMonth(),s=daysInMonth(d,r),l=byId("monthGrid");l.innerHTML="";let c=e||[];n&&"all"!==n&&(c=c.filter((e=>(e.building||"")===n))),c=i&&"all"!==i?c.filter((e=>e.id===i)):c,c=c.filter((e=>"Gedung Fisika"===(e.building||"")||ACTIVE_ROOM_IDS.length&&ACTIVE_ROOM_IDS.includes(e.id))),l.style.gridTemplateColumns=`200px repeat(${s}, 1fr)`;const u=document.createElement("div");u.className="month-head",u.textContent=new Date(d,r,1).toLocaleDateString(void 0,{month:"long",year:"numeric"}),u.style.textAlign="left",u.style.fontWeight="600",l.appendChild(u);for(let e=1;e<=s;e++){const t=document.createElement("div");t.className="month-head"+(isWeekend(d,r,e)?" weekend":""),t.textContent=e,l.appendChild(t)}const m=new Set(c.map((e=>e.id))),p=t.filter((e=>m.has(e.room_id))).filter((e=>"all"===o||e.status===o)).filter((e=>"pending"!==e.status)).filter((e=>e.date.startsWith(`${d}-${pad2(r+1)}-`))),f=new Map;for(const e of p)f.set(`${e.room_id}|${e.date}`,!0);c.forEach((e=>{const t=document.createElement("div");t.className="month-room",t.textContent=e.name,l.appendChild(t);for(let t=1;t<=s;t++){const a=document.createElement("div"),n=`${d}-${pad2(r+1)}-${pad2(t)}`,i=!0===f.get(`${e.id}|${n}`);a.className="month-cell "+(i?"busy":"free")+(isWeekend(d,r,t)?" weekend":""),a.title=`${e.name} · ${n} · ${i?"Busy":"Free"}`,a.addEventListener("click",(()=>{byId("tabDay").click(),setDateInput(n),render()})),l.appendChild(a)}}))}async function loadData(){try{const e=await fetch("./data/schedule.json",{cache:"no-store"});if(!e.ok)throw new Error("no schedule.json");return await e.json()}catch(e){return console.warn("Using demo data:",e.message),DEMO}}let VIEW="day",DATA=null;!function(){const e=new Date,t=fmtDate(new Date(e.getFullYear(),e.getMonth(),e.getDate()));loadData().then((e=>{DATA=expandFixedBookings(e);const a=byId("buildingFilter"),n=byId("roomFilter");function i(){const e="Gedung Fisika";n.innerHTML='<option value="all">Semua ruangan</option>';(DATA.rooms||[]).filter((t=>(t.building||"")===e||ACTIVE_ROOM_IDS.length&&ACTIVE_ROOM_IDS.includes(t.id))).forEach((e=>{const t=document.createElement("option");t.value=e.id,t.textContent=e.name,n.appendChild(t)}))}Array.from(new Set((DATA.rooms||[]).map((e=>e.building)).filter(Boolean))).sort().forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)})),i();setDateInput(nearestBookedDate(DATA.bookings,t));const o=byId("tabDay"),d=byId("tabMonth"),r=byId("dayWrap"),s=byId("monthWrap");function l(e){const t=new Date(byId("datePicker").value);t.setDate(t.getDate()+e),setDateInput(fmtDate(t))}o.addEventListener("click",(()=>{VIEW="day",o.classList.add("active"),d.classList.remove("active"),r.style.display="block",s.style.display="none",render()})),d.addEventListener("click",(()=>{VIEW="month",d.classList.add("active"),o.classList.remove("active"),r.style.display="none",s.style.display="block",render()})),window.render=function(){const e=byId("datePicker").value;if(!e)return;const t="Gedung Fisika";if("day"===VIEW)buildDayGrid(DATA,e,t,byId("roomFilter").value,byId("statusFilter").value);else{const a=new Date(e);buildMonthGrid(DATA,new Date(a.getFullYear(),a.getMonth(),1),t,byId("roomFilter").value,byId("statusFilter").value)}},byId("datePicker").addEventListener("change",render),byId("roomFilter").addEventListener("change",render),byId("buildingFilter").addEventListener("change",(()=>{i(),render()})),byId("statusFilter").addEventListener("change",render),byId("prev").addEventListener("click",(()=>{l("day"===VIEW?-1:-30),render()})),byId("next").addEventListener("click",(()=>{l("day"===VIEW?1:30),render()})),render()}))}();
